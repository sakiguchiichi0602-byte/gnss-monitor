<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>GNSS 疑似距離残差 リアルタイム監視 (GPSのみ)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns/locale/ja/index.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-streaming@2"></script>
    
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    
    <style>
        /* (CSSは変更ありません) */
        body { 
            font-family: sans-serif; 
            display: grid; 
            grid-template-columns: 1fr;
            grid-template-rows: auto auto 1fr; 
            height: 95vh; 
            gap: 10px; 
            padding: 10px; 
            background-color: #f4f7f6;
        }
        h1 { grid-row: 1; margin: 0; }
        #status-display { 
            grid-row: 2;
            text-align: center; font-size: 1.2em; font-weight: bold; 
            padding: 5px; border: 1px solid #ccc; border-radius: 5px; 
            background-color: #fff;
        }
        #residual-chart-container { 
            grid-row: 3; 
            position: relative; 
            height: 100%; 
            width: 100%;
            background-color: #fff;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
    </style>
</head>
<body>

    <h1>GPS衛星 疑似距離残差 リアルタイム監視</h1>
    
    <div id="status-display">ステータス: 接続待機中...</div>

    <div class="chart-container" id="residual-chart-container">
        <canvas id="residualChart"></canvas>
    </div>

    <script>
        // --- ★★★ 設定項目 (HiveMQ Cloud) ★★★ ---
        // 1. HiveMQ Cloudの「Public Address」(画像から)
        const MQTT_BROKER_HOST = "249e081497cc4102b789e090b4e02268.s1.eu.hivemq.cloud";
        const MQTT_TOPIC = "gnss/raspi/sbf-rtk-residuals";

        // 2. ユーザー名とパスワード (テキストから)
        const MQTT_USERNAME = "irie_lab";
        const MQTT_PASSWORD = "Suya2659";

        // 3. ブラウザ(WebSocket)用の接続URLとオプションを作成
        // ★★★ ポートを 8884 に修正 (画像参照) ★★★
        const MQTT_BROKER_URL = `wss://${MQTT_BROKER_HOST}:8884/mqtt`; 
        const MQTT_OPTIONS = {
            username: MQTT_USERNAME,
            password: MQTT_PASSWORD,
            connectTimeout: 5000 
        };
        // -----------------------------------------------------------------

        const DURATION_SEC = 7200; // 2時間

        // --- $SAT メッセージのフォーマット ---
        const IDX_WEEK = 1;
        const IDX_GPST_SEC = 2;
        const IDX_SAT_ID = 3;
        const IDX_FREQ_ID = 4;
        const IDX_RES_CODE = 7; // 疑似距離残差 (m)

        const GPS_EPOCH = new Date(Date.UTC(1980, 0, 6, 0, 0, 0));
        const statusDisplay = document.getElementById('status-display');
        
        // (中略: 衛星ごとの色付けロジック)
        const satColors = {};
        const availableColors = [
            '#E6194B', '#3CB44B', '#4363D8', '#F58231', '#911EB4', '#46F0F0', 
            '#F032E6', '#BCF60C', '#FABEBE', '#008080', '#E6BEFF', '#9A6324',
            '#FFFAC8', '#800000', '#AAFFC3', '#808000', '#FFD8B1', '#000075'
        ];
        let colorIndex = 0;
        function getSatColor(satId) {
            if (!satColors[satId]) {
                satColors[satId] = availableColors[colorIndex % availableColors.length];
                colorIndex++;
            }
            return satColors[satId];
        }
        function getLineStyle(freqId) {
            if (String(freqId) === '2') return 'dash';
            if (['5', '7'].includes(String(freqId))) return 'dot';
            return 'solid';
        }

        // --- グラフの初期化 (Chart.js) ---
        // (中略: グラフ設定、JST表示設定は変更なし)
        const resCtx = document.getElementById('residualChart').getContext('2d');
        const residualChart = new Chart(resCtx, {
            type: 'line',
            data: { datasets: [] },
            options: {
                animation: false,
                scales: {
                    x: {
                        type: 'realtime',
                        realtime: {
                            duration: DURATION_SEC * 1000,
                            refresh: 1000, // 1秒ごとに更新
                            delay: 1000,
                        },
                        time: { 
                            unit: 'minute', 
                            displayFormats: { minute: 'HH:mm' },
                            adapter: {
                                date: dateFns.parseISO,
                                format: dateFns.format,
                                add: dateFns.add,
                                diff: dateFns.differenceInMilliseconds,
                                startOf: dateFns.startOfSecond,
                                endOf: dateFns.endOfSecond
                            },
                        },
                        title: { display: true, text: '時刻 (JST)' },
                        ticks: {
                           source: 'auto',
                           maxRotation: 45,
                           minRotation: 45,
                           callback: function(value, index, ticks) {
                                const date = new Date(value);
                                return dateFns.format(date, 'HH:mm:ss', { locale: dateFns.locale.ja });
                           }
                        }
                    },
                    y: {
                        title: { display: true, text: '残差 (m)' },
                        suggestedMin: -2.0,
                        suggestedMax: 2.0,
                    }
                },
                plugins: { legend: { position: 'right' } },
                maintainAspectRatio: false
            }
        });
        
        // (中略: GPSTimeからJSTへの変換ロジック)
        function gpstToDateJST(week, gpst_sec) {
            const msSinceEpoch = GPS_EPOCH.getTime() + (week * 7 * 24 * 60 * 60 * 1000) + (gpst_sec * 1000);
            const utcDate = new Date(msSinceEpoch);
            const jstTime = utcDate.getTime() + (9 * 60 * 60 * 1000);
            return new Date(jstTime);
        }
        
        // (中略: データセット作成ロジック)
        function getOrCreateDataset(satId, freqId) {
            const label = `${satId} (L${freqId})`;
            let dataset = residualChart.data.datasets.find(ds => ds.label === label);
            if (!dataset) {
                const color = getSatColor(satId);
                const style = getLineStyle(freqId);
                dataset = {
                    label: label,
                    data: [],
                    borderColor: color,
                    backgroundColor: color + "80",
                    borderWidth: 2,
                    pointRadius: 0,
                    borderDash: (style === 'dash' ? [5, 5] : (style === 'dot' ? [2, 3] : [0, 0])),
                    tension: 0.1
                };
                residualChart.data.datasets.push(dataset);
            }
            return dataset;
        }

        // --- MQTTクライアントのセットアップ ---
        console.log(`MQTTブローカー (${MQTT_BROKER_URL}) に接続中...`);
        // ★ 認証 (MQTT_OPTIONS) *あり* で接続
        const client = mqtt.connect(MQTT_BROKER_URL, MQTT_OPTIONS); 

        client.on('connect', () => {
            statusDisplay.textContent = "MQTT接続完了。データ待機中...";
            statusDisplay.style.color = "green";
            console.log("MQTT接続成功。");
            client.subscribe(MQTT_TOPIC, (err) => {
                if (err) {
                    statusDisplay.textContent = "トピック購読失敗";
                    console.error("購読失敗:", err);
                } else {
                    console.log(`トピック '${MQTT_TOPIC}' の購読を開始しました。`);
                }
            });
        });

        client.on('error', (err) => {
            statusDisplay.textContent = `MQTT接続エラー: ${err.message}`;
            statusDisplay.style.color = "red";
            console.error("MQTT接続エラー:", err);
        });

        // --- メッセージ受信時の処理 ($SATを解析) ---
        // (ロジックは変更なし)
        client.on('message', (topic, payload) => {
            try {
                const line = payload.toString().trim();
                
                if (!line.startsWith("$SAT")) return;
                const parts = line.split(',');
                if (parts.length <= IDX_RES_CODE) return;
                
                const sat_id = parts[IDX_SAT_ID];
                
                if (!sat_id.startsWith('G')) { // GPSのみフィルター
                    return;
                }
                
                const week = parseInt(parts[IDX_WEEK], 10);
                const gpst_sec = parseFloat(parts[IDX_GPST_SEC]);
                const time_val_jst = gpstToDateJST(week, gpst_sec);
                const freq_id = parts[IDX_FREQ_ID];
                const residual_val = parseFloat(parts[IDX_RES_CODE]);
                const dataset = getOrCreateDataset(sat_id, freq_id);
                
                dataset.data.push({
                    x: time_val_jst,
                    y: residual_val
                });

                statusDisplay.textContent = `最終受信: ${time_val_jst.toLocaleTimeString('ja-JP')} (JST)`;

            } catch (e) {
                console.warn("データ解析エラー:", e, " | 受信データ:", line);
            }
        });

    </script>
</body>
</html>