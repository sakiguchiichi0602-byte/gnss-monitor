<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GNSS 総合モニター</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.1.0/paho-mqtt.js"></script>

    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; }
        h1 { margin: 10px 0; }
        #status { width: 95vw; padding: 10px; background-color: #eee; border-radius: 5px; font-weight: bold; box-sizing: border-box; }
        #status.error { background-color: #ffdddd; color: #d8000c; }
        #status.success { background-color: #ddffdd; color: #008000; }
        
        /* ★ 新しいレイアウト (Flexbox) ★ */
        #main-container {
            display: flex;
            flex-direction: row; /* 横並び */
            width: 95vw;
            height: 80vh;
            margin-top: 10px;
        }
        #left-column {
            flex: 3; /* 幅 3/4 */
            display: flex;
            flex-direction: column; /* 縦並び */
            height: 100%;
        }
        #right-column {
            flex: 1; /* 幅 1/4 */
            height: 100%;
            padding-left: 10px;
            box-sizing: border-box;
        }
        .chart-container {
            position: relative;
            width: 100%;
            height: 100%; /* 親の高さに合わせる */
            min-height: 150px; /* 最小高さを確保 */
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        #scatter-container {
            height: 50%; /* 右カラムの半分 */
            margin-bottom: 10px;
        }
        #quality-info {
            height: 48%; /* 右カラムの残り */
            font-size: 1.2em;
            padding: 15px;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        canvas {
            max-height: 100%; /* コンテナからはみ出さない */
        }
    </style>
</head>
<body>
    <h1>GNSS 総合モニター (残差・位置)</h1>
    <div id="status">MQTTブローカーに接続中...</div>
    
    <div id="main-container">
        <div id="left-column">
            <div class="chart-container" style="flex: 1.2;"> <canvas id="residualChart"></canvas>
            </div>
            <div class="chart-container" style="flex: 1;">
                <canvas id="latlonChart"></canvas>
            </div>
            <div class="chart-container" style="flex: 1; margin-bottom: 0;">
                <canvas id="heightChart"></canvas>
            </div>
        </div>
        
        <div id="right-column">
            <div class="chart-container" id="scatter-container">
                <canvas id="scatterChart"></canvas>
            </div>
            <div id="quality-info">
                <strong>ステータス:</strong>
                <p id="current-quality">---</p>
                <strong>基準位置 (Lat, Lon):</strong>
                <p id="base-pos" style="font-size: 0.8em;">---</p>
                <strong>現在位置 (Δm):</strong>
                <p id="delta-pos" style="font-size: 0.8em;">---</p>
            </div>
        </div>
    </div>

    <script>
        // --- ★★★★★ 設定項目 ★★★★★ ---
        const MQTT_HOST = "249e081497cc4102b789e090b4e02268.s1.eu.hivemq.cloud";
        const MQTT_PORT = 8884;
        const MQTT_USERNAME = "irie_lab";
        const MQTT_PASSWORD = "Suya2659";

        // ★ 2つのトピックを定義
        const MQTT_TOPIC_RESIDUALS = "gnss/raspi/sbf-rtk-residuals";
        const MQTT_TOPIC_POSITION = "gnss/raspi/position-llh";
        // -------------------------------------------------------------

        // --- 定数 (変更なし) ---
        const MAX_POINTS = 7200; // 2時間分
        const GPS_EPOCH_MS = new Date('1980-01-06T00:00:00Z').getTime();
        const statusDiv = document.getElementById('status');
        
        // --- 色・スタイル管理 (変更なし) ---
        const satColors = new Map();
        let colorIndex = 0;
        const available_colors = ['#E6194B', '#3CB44B', '#4363D8', '#F58231', '#911EB4', '#46F0F0', '#F032E6', '#BCF60C', '#008080', '#E6BEFF', '#9A6324', '#800000', '#000075'];
        function getSatColor(sat_id) {
            if (!satColors.has(sat_id)) {
                satColors.set(sat_id, available_colors[colorIndex % available_colors.length]);
                colorIndex++;
            }
            return satColors.get(sat_id);
        }
        function getLineStyle(freq_id) {
            const id_str = String(freq_id);
            if (id_str === '2') return [5, 5];
            if (id_str === '5' || id_str === '7') return [2, 2];
            return [];
        }
        const qualityMap = { 0: "無効", 1: "SPS", 2: "DGPS", 4: "RTK Fixed", 5: "RTK Float" };
        const qualityColor = { 0: "#999", 1: "#F58231", 2: "#4363D8", 4: "#3CB44B", 5: "#E6194B" };

        
        function updateStatus(message, isError = false) {
            console.log(message);
            statusDiv.textContent = message;
            if (isError) { statusDiv.className = 'error'; }
            else { statusDiv.className = (message.includes("接続しました")) ? 'success' : ''; }
        }

        // --- ★ HELPER: 緯度経度の差をメートルに変換 (簡易版) ---
        // 基準点 (0,0) からのメートル変位を計算
        const R_EARTH = 6378137.0; // 地球の半径
        function calculate_meters(base_lat, base_lon, new_lat, new_lon) {
            const dLat = (new_lat - base_lat) * (Math.PI / 180);
            const dLon = (new_lon - base_lon) * (Math.PI / 180);
            const base_lat_rad = base_lat * (Math.PI / 180);

            const delta_y_m = dLat * R_EARTH; // 緯度(North)方向の変位 [m]
            const delta_x_m = dLon * R_EARTH * Math.cos(base_lat_rad); // 経度(East)方向の変位 [m]
            
            return [delta_x_m, delta_y_m]; // [East, North]
        }

        // --- ★ データ保持用の構造 ---
        // (1) 残差データ (既存)
        const satDataSets = new Map();
        
        // (2) 位置データ (新規)
        let basePosition = null; // 基準点 ( {lat, lon, h} )
        const posData = {
            t: [],     // タイムスタンプ
            lat_m: [], // 緯度(North)変位 [m]
            lon_m: [], // 経度(East)変位 [m]
            h_m: []    // 高さ(Up)変位 [m]
        };
        const posScatterData = []; // 散布図用 ( {x, y, q} )

        // --- ★ 4つのChart.jsインスタンスを初期化 ---
        const ctxRes = document.getElementById('residualChart').getContext('2d');
        const residualChart = new Chart(ctxRes, {
            type: 'line', data: { datasets: [] },
            options: { responsive: true, maintainAspectRatio: false,
                scales: { x: { type: 'time', time: { unit: 'minute', displayFormats: { minute: 'HH:mm' } } }, y: { title: { display: true, text: '残差 (m)' } } },
                plugins: { title: { display: true, text: 'GPS衛星 疑似距離残差 (リアルタイム)' } }
            }
        });

        const ctxLatLon = document.getElementById('latlonChart').getContext('2d');
        const latlonChart = new Chart(ctxLatLon, {
            type: 'line',
            data: {
                labels: [], // 共通のタイムスタンプ
                datasets: [
                    { label: 'North (m)', data: [], borderColor: '#4363D8', borderWidth: 2, pointRadius: 0, tension: 0.1 },
                    { label: 'East (m)', data: [], borderColor: '#3CB44B', borderWidth: 2, pointRadius: 0, tension: 0.1 }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false,
                scales: { x: { type: 'time', time: { unit: 'minute', displayFormats: { minute: 'HH:mm' } } }, y: { title: { display: true, text: '変位 (m)' } } },
                plugins: { title: { display: true, text: '時間 - 水平変位 (基準点から)' } }
            }
        });

        const ctxHeight = document.getElementById('heightChart').getContext('2d');
        const heightChart = new Chart(ctxHeight, {
            type: 'line',
            data: {
                labels: [], // 共通のタイムスタンプ
                datasets: [
                    { label: 'Up (m)', data: [], borderColor: '#F58231', borderWidth: 2, pointRadius: 0, tension: 0.1 }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false,
                scales: { x: { type: 'time', time: { unit: 'minute', displayFormats: { minute: 'HH:mm' } } }, y: { title: { display: true, text: '変位 (m)' } } },
                plugins: { title: { display: true, text: '時間 - 高さ変位 (基準点から)' } }
            }
        });

        const ctxScatter = document.getElementById('scatterChart').getContext('2d');
        const scatterChart = new Chart(ctxScatter, {
            type: 'scatter',
            data: {
                datasets: [
                    // 品質ごとにデータセットを分ける
                    { label: 'RTK Fixed (4)', data: [], backgroundColor: qualityColor[4], pointRadius: 3 },
                    { label: 'RTK Float (5)', data: [], backgroundColor: qualityColor[5], pointRadius: 3 },
                    { label: 'DGPS (2)', data: [], backgroundColor: qualityColor[2], pointRadius: 3 },
                    { label: 'SPS (1)', data: [], backgroundColor: qualityColor[1], pointRadius: 3 },
                    { label: '無効 (0)', data: [], backgroundColor: qualityColor[0], pointRadius: 3 }
                ]
            },
            options: { responsive: true, maintainAspectRatio: true, aspectRatio: 1, // ★ 正方形を維持
                scales: { 
                    x: { title: { display: true, text: 'East (m)' }, grid: { color: '#ccc' } }, 
                    y: { title: { display: true, text: 'North (m)' }, grid: { color: '#ccc' } } 
                },
                plugins: { title: { display: true, text: '水平位置 (N vs E)' } }
            }
        });

        // --- MQTTクライアントの初期化 ---
        const clientID = "gnss_web_monitor_combined_" + new Date().getTime();
        const client = new Paho.Client(MQTT_HOST, MQTT_PORT, clientID);

        client.onConnectionLost = (responseObject) => {
            if (responseObject.errorCode !== 0) {
                updateStatus(`MQTT接続が切れました: ${responseObject.errorMessage}。5秒後に再接続します...`, true);
                setTimeout(startConnect, 5000);
            }
        };

        // --- ★★★ メッセージ受信 (メインロジック) ★★★ ---
        client.onMessageArrived = (message) => {
            try {
                // (1) 残差トピックの処理
                if (message.destinationName === MQTT_TOPIC_RESIDUALS) {
                    handleResidualMessage(message.payloadString);
                }
                // (2) 位置トピックの処理
                else if (message.destinationName === MQTT_TOPIC_POSITION) {
                    handlePositionMessage(message.payloadString);
                }
            } catch (e) {
                console.error(`データ解析エラー: ${e}`, message.payloadString);
            }
        };
        
        // --- 残差メッセージの処理関数 (既存ロジック) ---
        function handleResidualMessage(line) {
            const parts = line.split(',');
            if (parts.length < 5) return; 

            // 1. タイムスタンプ
            const week = parseInt(parts[0]);
            const gpst_sec = parseFloat(parts[1]);
            const utc_ms = GPS_EPOCH_MS + (week * 7 * 24 * 60 * 60 * 1000) + (gpst_sec * 1000);
            const timestamp = new Date(utc_ms); 
            // 2. 衛星ID, 周波数ID
            const sat_id = parts[2];
            const freq_id = parts[3];
            // 3. 残差
            const residual_val = parseFloat(parts[4]);
            if (isNaN(residual_val)) return; 

            const key = `${sat_id} (L${freq_id})`;
            
            // 4. データセットを探す
            let dataset = satDataSets.get(key);
            if (!dataset) {
                dataset = {
                    label: key, data: [],
                    borderColor: getSatColor(sat_id), borderDash: getLineStyle(freq_id),
                    borderWidth: 2, pointRadius: 0, tension: 0.1
                };
                satDataSets.set(key, dataset);
                residualChart.data.datasets.push(dataset);
            }
            
            // 5. データを追加
            dataset.data.push({ x: timestamp, y: residual_val });
            if (dataset.data.length > MAX_POINTS) {
                dataset.data.shift();
            }
        }

        // --- ★ 位置メッセージの処理関数 (新規) ---
        function handlePositionMessage(line) {
            // "Unix秒,緯度(DD),経度(DD),高さ(MSL),品質"
            const parts = line.split(',');
            if (parts.length < 5) return;
            
            const timestamp = new Date(parseFloat(parts[0]) * 1000);
            const lat_dd = parseFloat(parts[1]);
            const lon_dd = parseFloat(parts[2]);
            const height = parseFloat(parts[3]);
            const quality = parseInt(parts[4]);
            
            if (isNaN(lat_dd)) return;

            // 1. 基準点が未設定の場合、最初の有効な解を基準点にする
            if (!basePosition && quality > 0) {
                basePosition = { lat: lat_dd, lon: lon_dd, h: height };
                console.log("基準点を設定:", basePosition);
                document.getElementById('base-pos').textContent = `${lat_dd.toFixed(7)}, ${lon_dd.toFixed(7)}`;
                return;
            }
            
            // 2. 基準点が設定済みの場合、変位を計算
            if (basePosition) {
                const [delta_x_m, delta_y_m] = calculate_meters(basePosition.lat, basePosition.lon, lat_dd, lon_dd);
                const delta_h_m = height - basePosition.h;

                // 3. 時系列グラフ用データを追加
                posData.t.push(timestamp);
                posData.lat_m.push(delta_y_m); // North
                posData.lon_m.push(delta_x_m); // East
                posData.h_m.push(delta_h_m);   // Up
                
                // 4. 散布図用データを追加
                const scatterPoint = { x: delta_x_m, y: delta_y_m, q: quality };
                posScatterData.push(scatterPoint);

                // 5. 古いデータを削除
                if (posData.t.length > MAX_POINTS) {
                    posData.t.shift();
                    posData.lat_m.shift();
                    posData.lon_m.shift();
                    posData.h_m.shift();
                }
                if (posScatterData.length > MAX_POINTS) {
                    posScatterData.shift();
                }
                
                // 6. 品質表示を更新
                const q_text = qualityMap[quality] || `不明 (${quality})`;
                const q_color = qualityColor[quality] || "#000";
                const q_elem = document.getElementById('current-quality');
                q_elem.textContent = q_text;
                q_elem.style.color = q_color;
                q_elem.style.fontWeight = (quality === 4) ? 'bold' : 'normal';
                
                document.getElementById('delta-pos').textContent = 
                    `N: ${delta_y_m.toFixed(3)} m, E: ${delta_x_m.toFixed(3)} m, U: ${delta_h_m.toFixed(3)} m`;
            }
        }

        // --- 接続処理 (★ 2つのトピックを購読) ---
        function startConnect() {
            updateStatus(`MQTTブローカー (${MQTT_HOST}:${MQTT_PORT}) に接続中...`);
            client.connect({
                userName: MQTT_USERNAME,
                password: MQTT_PASSWORD,
                useSSL: true, 
                onSuccess: () => {
                    updateStatus(`MQTTブローカーに接続しました。トピックの購読を開始します...`, false);
                    client.subscribe(MQTT_TOPIC_RESIDUALS); // 残差
                    client.subscribe(MQTT_TOPIC_POSITION);  // 位置
                },
                onFailure: (response) => {
                    updateStatus(`MQTT接続に失敗: ${response.errorMessage}`, true);
                }
            });
        }
        
        // --- ★ グラフの更新ループ (4つのグラフを更新) ---
        setInterval(() => {
            if (!client.isConnected()) return;
            
            // 1. 残差グラフの更新
            // (既存ロジック: データセットを差し替える)
            const activeDatasets = [];
            const now = new Date();
            const timeLimit = now.getTime() - 30 * 60 * 1000; // 30分
            
            for (const [key, dataset] of satDataSets.entries()) {
                if (dataset.data.length > 0) {
                    // 古いデータをフィルタリング
                    while(dataset.data.length > 0 && dataset.data[0].x.getTime() < timeLimit) {
                        dataset.data.shift();
                    }
                    if (dataset.data.length > 0) {
                        // 最後のデータが古すぎたら非表示
                        if (dataset.data[dataset.data.length - 1].x.getTime() > (now.getTime() - 60000)) { // 1分以内
                             activeDatasets.push(dataset);
                        }
                    }
                }
            }
            residualChart.data.datasets = activeDatasets;
            residualChart.update('none');
            
            // 2. 位置グラフの更新
            latlonChart.data.labels = posData.t;
            latlonChart.data.datasets[0].data = posData.lat_m; // North
            latlonChart.data.datasets[1].data = posData.lon_m; // East
            latlonChart.update('none');
            
            // 3. 高さグラフの更新
            heightChart.data.labels = posData.t;
            heightChart.data.datasets[0].data = posData.h_m; // Up
            heightChart.update('none');

            // 4. 散布図の更新 (品質ごとにデータを振り分ける)
            scatterChart.data.datasets.forEach(ds => ds.data = []); // 全てリセット
            posScatterData.forEach(p => {
                if (p.q === 4) scatterChart.data.datasets[0].data.push({x: p.x, y: p.y});
                else if (p.q === 5) scatterChart.data.datasets[1].data.push({x: p.x, y: p.y});
                else if (p.q === 2) scatterChart.data.datasets[2].data.push({x: p.x, y: p.y});
                else if (p.q === 1) scatterChart.data.datasets[3].data.push({x: p.x, y: p.y});
                else scatterChart.data.datasets[4].data.push({x: p.x, y: p.y});
            });
            scatterChart.update('none');

        }, 1000); // 1秒ごとに全グラフを更新

        // --- 実行開始 ---
        startConnect();

    </script>
</body>
</html>