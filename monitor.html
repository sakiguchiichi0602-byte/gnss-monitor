<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>GNSS リアルタイム監視</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    
    <style>
        /* ★★★ レイアウト修正 (GridSpec風) ★★★ */
        body { 
            font-family: sans-serif; 
            display: grid; 
            /* 3行 x 2列 (左:時系列(幅1.5), 右:軌跡(幅1)) */
            grid-template-columns: 1.5fr 1fr;
            grid-template-rows: auto auto 1fr 1fr 1fr; /* ヘッダー2行 + グラフ3行 */
            height: 95vh; 
            gap: 10px; 
            padding: 10px; 
        }
        h1 { grid-column: 1 / -1; grid-row: 1; margin: 0; } /* 全幅 (1行目) */
        #status-display { 
            grid-column: 1 / -1; /* 全幅 (2行目) */
            grid-row: 2;
            text-align: center; font-size: 1.5em; font-weight: bold; 
            padding: 5px; border: 1px solid #ccc; border-radius: 5px; 
        }
        
        /* --- グラフの配置 --- */
        /* 左列 */
        #lat-chart-container { grid-row: 3; grid-column: 1; }
        #lon-chart-container { grid-row: 4; grid-column: 1; }
        #ns-chart-container  { grid-row: 5; grid-column: 1; }
        
        /* 右列 (3行目から3行分を結合) */
        #track-chart-container { 
            grid-row: 3 / span 3; 
            grid-column: 2;
        }

        .chart-container { position: relative; height: 100%; width: 100%; }
    </style>
</head>
<body>

    <h1>リアルタイム GNSS監視ダッシュボード</h1>
    
    <div id="status-display">ステータス: 接続中...</div>

    <div class="chart-container" id="lat-chart-container"><canvas id="latChart"></canvas></div>
    <div class="chart-container" id="lon-chart-container"><canvas id="lonChart"></canvas></div>
    <div class="chart-container" id="ns-chart-container"><canvas id="nsChart"></canvas></div>
    
    <div class="chart-container" id="track-chart-container"><canvas id="trackChart"></canvas></div>

    <script>
        // --- 1. MQTT接続設定 ---
        const MQTT_BROKER = "wss://test.mosquitto.org:8080"; // ws:// とポート 8081
        const MQTT_TOPIC = "gnss/raspi/sbf-rtk"; // ラズパイ(streamer.py)と合わせる

        const MAX_POINTS = 200;
        
        const STATUS_MAP = {
            "1": "FIX (高精度)", "2": "FLOAT (準高精度)", "5": "SINGLE (単独)",
            "0": "---", "6": "PPP"
        };

        const statusDisplay = document.getElementById('status-display');

        // --- 2. グラフの初期化 (Chart.js) ---
        // 時系列グラフ(緯度, 経度, 衛星数)を作成する共通関数
        function createChart(canvasId, yLabel) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            return new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: yLabel, data: [],
                        borderColor: (yLabel.includes('緯度') ? 'blue' : (yLabel.includes('経度') ? 'orange' : 'gray')),
                        borderWidth: 1.5, pointRadius: 2, tension: 0.1
                    }]
                },
                options: {
                    animation: false,
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'second', displayFormats: { second: 'HH:mm:ss' } },
                            ticks: { maxRotation: 45, minRotation: 45 }
                        },
                        y: {
                            title: { display: true, text: yLabel },
                            ticks: { 
                                format: (yLabel.includes('緯度') || yLabel.includes('経度')) ? { precision: 6 } : {}
                            }
                        }
                    },
                    plugins: { legend: { display: false } },
                    maintainAspectRatio: false // コンテナサイズに合わせる
                }
            });
        }
        
        // 軌跡グラフ (X=Lon, Y=Lat)
        const trackCtx = document.getElementById('trackChart').getContext('2d');
        const trackChart = new Chart(trackCtx, {
            type: 'scatter',
            data: {
                datasets: [{
                    label: '軌跡', data: [],
                    borderColor: 'green', backgroundColor: 'green',
                    showLine: true, tension: 0.1
                }]
            },
            options: {
                animation: false,
                scales: {
                    x: { title: { display: true, text: '経度 (Lon)' }, ticks: { format: { precision: 6 } } },
                    y: { title: { display: true, text: '緯度 (Lat)' }, ticks: { format: { precision: 6 } } }
                },
                aspectRatio: 1, // 縮尺を合わせる
                plugins: { legend: { display: false } },
                maintainAspectRatio: false
            }
        });

        const latChart = createChart('latChart', '緯度 (Lat)');
        const lonChart = createChart('lonChart', '経度 (Lon)');
        const nsChart = createChart('nsChart', '使用衛星数 (NS)');
        
        // --- 3. グラフデータ更新用関数 ---
        function addDataToChart(chart, timestamp, value) {
            const data = chart.data.datasets[0].data;
            if (data.length >= MAX_POINTS) data.shift();
            data.push({ x: timestamp, y: value });
            chart.update('quiet');
        }
        
        function addTrackData(lon, lat) {
            const data = trackChart.data.datasets[0].data;
            if (data.length >= MAX_POINTS) data.shift();
            data.push({ x: lon, y: lat });
            trackChart.update('quiet');
        }

        // --- 4. MQTTクライアントのセットアップ ---
        const client = mqtt.connect(MQTT_BROKER);

        client.on('connect', () => {
            statusDisplay.textContent = "MQTT接続完了。データ待機中...";
            statusDisplay.style.color = "orange";
            client.subscribe(MQTT_TOPIC, (err) => {
                if (err) statusDisplay.textContent = "トピック購読失敗";
            });
        });

        client.on('error', (err) => {
            statusDisplay.textContent = "MQTT接続エラー";
            statusDisplay.style.color = "red";
        });

        // --- 5. メッセージ受信時の処理 (メインロジック) ---
        client.on('message', (topic, payload) => {
            try {
                const line = payload.toString().trim();
                const parts = line.split(/\s+/); 
                
                if (parts.length < 7 || parts[0].startsWith('%')) return;
                
                const timestr = parts[0] + " " + parts[1];
                const time_val = new Date(timestr);
                
                const lat = parseFloat(parts[2]);
                const lon = parseFloat(parts[3]);
                const status_q = parts[5];
                const ns = parseInt(parts[6]);

                // ステータス表示を更新
                const statusText = STATUS_MAP[status_q] || `不明(${status_q})`;
                statusDisplay.textContent = `測位ステータス: ${statusText} (衛星数: ${ns})`;
                
                if (status_q === "1") statusDisplay.style.color = "green";
                else if (status_q === "2") statusDisplay.style.color = "orange";
                else statusDisplay.style.color = "red";
                
                // グラフにデータを追加
                addDataToChart(latChart, time_val, lat);
                addDataToChart(lonChart, time_val, lon);
                addDataToChart(nsChart, time_val, ns);
                addTrackData(lon, lat); // 軌跡グラフ

            } catch (e) {
                // console.warn("データ解析エラー:", e, " | 受信データ:", line);
            }
        });

    </script>
</body>

</html>


