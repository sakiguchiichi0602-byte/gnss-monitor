<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>GNSS 疑似距離残差 リアルタイム監視</title>
    
    <!-- Chart.js と date-fns アダプタ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    
    <!-- ★ Chart.js リアルタイムストリーミングプラグイン を追加 -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-streaming@2"></script>
    
    <!-- MQTT.js -->
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    
    <style>
        body { 
            font-family: sans-serif; 
            display: grid; 
            /* ヘッダー2行 + グラフ1行 */
            grid-template-columns: 1fr;
            grid-template-rows: auto auto 1fr; 
            height: 95vh; 
            gap: 10px; 
            padding: 10px; 
            background-color: #f4f7f6;
        }
        h1 { grid-row: 1; margin: 0; }
        #status-display { 
            grid-row: 2;
            text-align: center; font-size: 1.2em; font-weight: bold; 
            padding: 5px; border: 1px solid #ccc; border-radius: 5px; 
            background-color: #fff;
        }
        
        /* グラフコンテナ */
        #residual-chart-container { 
            grid-row: 3; 
            position: relative; 
            height: 100%; 
            width: 100%;
            background-color: #fff;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
    </style>
</head>
<body>

    <h1>リアルタイム 疑似距離残差 監視ダッシュボード</h1>
    
    <div id="status-display">ステータス: 接続待機中...</div>

    <!-- グラフは「疑似距離残差」の一つだけにする -->
    <div class="chart-container" id="residual-chart-container">
        <canvas id="residualChart"></canvas>
    </div>

    <script>
        // --- 1. MQTT接続設定 ---
        const MQTT_BROKER = "wss://test.mosquitto.org:8081"; // WebSocket Secure
        // ★トピックを $SATデータ (残差) を送信するものに変更
        const MQTT_TOPIC = "gnss/raspi/sbf-rtk-residuals"; 

        // 2時間 (秒)
        const DURATION_SEC = 7200; 

        // --- $SAT メッセージのフォーマット ---
        // $SAT,週,GPST秒,衛星ID,周波数ID,仰角,方位角,擬似距離残差(m),搬送波位相残差(m),...
        const IDX_WEEK = 1;
        const IDX_GPST_SEC = 2;
        const IDX_SAT_ID = 3;
        const IDX_FREQ_ID = 4;
        const IDX_RES_CODE = 7; // ★プロット対象: 疑似距離残差 (m)

        // GPSTimeのエポック (1980年1月6日 0時 UTC)
        // JavaScriptのDate()は月を0-indexed (0=1月)で扱う
        const GPS_EPOCH = new Date(Date.UTC(1980, 0, 6, 0, 0, 0));

        const statusDisplay = document.getElementById('status-display');
        
        // 衛星ごとの色を保持するマップ
        const satColors = {};
        const availableColors = [
            '#E6194B', '#3CB44B', '#4363D8', '#F58231', '#911EB4', '#46F0F0', 
            '#F032E6', '#BCF60C', '#FABEBE', '#008080', '#E6BEFF', '#9A6324',
            '#FFFAC8', '#800000', '#AAFFC3', '#808000', '#FFD8B1', '#000075'
        ];
        let colorIndex = 0;

        function getSatColor(satId) {
            if (!satColors[satId]) {
                satColors[satId] = availableColors[colorIndex % availableColors.length];
                colorIndex++;
            }
            return satColors[satId];
        }

        // --- 2. グラフの初期化 (Chart.js) ---
        const resCtx = document.getElementById('residualChart').getContext('2d');
        const residualChart = new Chart(resCtx, {
            type: 'line',
            data: {
                datasets: [] // データセットは動的に追加する
            },
            options: {
                animation: false,
                scales: {
                    x: {
                        type: 'realtime', // ★ストリーミングプラグインを使用
                        realtime: {
                            duration: DURATION_SEC * 1000, // 2時間 (ミリ秒)
                            refresh: 2000, // 2秒ごとにグラフ描画（負荷軽減）
                            delay: 1000,   // 1秒の描画遅延
                            pause: false,  // 一時停止しない
                        },
                        time: { 
                            unit: 'minute', 
                            displayFormats: { minute: 'HH:mm' } 
                        },
                        title: { display: true, text: '時刻 (UTC)' }
                    },
                    y: {
                        title: { display: true, text: '疑似距離残差 (m)' },
                        suggestedMin: -2.0, // Y軸の目安
                        suggestedMax: 2.0,
                    }
                },
                plugins: { 
                    legend: { 
                        position: 'right', // 凡例を右側に表示
                    } 
                },
                maintainAspectRatio: false // コンテナサイズに合わせる
            }
        });
        
        /**
         * GPSTime(週, 秒)をJavaScriptのDateオブジェクトに変換
         */
        function gpstToDate(week, gpst_sec) {
            const msSinceEpoch = GPS_EPOCH.getTime() + (week * 7 * 24 * 60 * 60 * 1000) + (gpst_sec * 1000);
            return new Date(msSinceEpoch);
        }

        /**
         * 衛星IDと周波数IDからデータセット(線)を探す (なければ作成する)
         */
        function getOrCreateDataset(satId, freqId) {
            const label = `${satId} (L${freqId})`;
            
            let dataset = residualChart.data.datasets.find(ds => ds.label === label);
            
            if (!dataset) {
                const color = getSatColor(satId);
                
                // 周波数ID (1=L1, 2=L2, 5=L5 など)
                let dash = [0, 0]; // 実線 (L1)
                if (String(freqId) === '2') {
                    dash = [5, 5]; // 破線 (L2)
                } else if (['5', '7'].includes(String(freqId))) {
                    dash = [2, 3]; // 点線 (L5/L7)
                }

                dataset = {
                    label: label,
                    data: [],
                    borderColor: color,
                    backgroundColor: color + "80", // 少し透明に
                    borderWidth: 2,
                    pointRadius: 0, // 点を非表示（負荷軽減）
                    borderDash: dash,
                    tension: 0.1
                };
                residualChart.data.datasets.push(dataset);
            }
            return dataset;
        }

        // --- 3. MQTTクライアントのセットアップ ---
        const client = mqtt.connect(MQTT_BROKER);

        client.on('connect', () => {
            statusDisplay.textContent = "MQTT接続完了。データ待機中...";
            statusDisplay.style.color = "green";
            client.subscribe(MQTT_TOPIC, (err) => {
                if (err) statusDisplay.textContent = "トピック購読失敗";
            });
        });

        client.on('error', (err) => {
            statusDisplay.textContent = "MQTT接続エラー";
            statusDisplay.style.color = "red";
        });

        // --- 4. メッセージ受信時の処理 ($SATを解析) ---
        client.on('message', (topic, payload) => {
            try {
                const line = payload.toString().trim();
                
                // $SAT行以外は無視
                if (!line.startsWith("$SAT")) return;

                const parts = line.split(',');
                
                if (parts.length <= IDX_RES_CODE) return;
                
                // 1. タイムスタンプを計算
                const week = parseInt(parts[IDX_WEEK], 10);
                const gpst_sec = parseFloat(parts[IDX_GPST_SEC]);
                const time_val = gpstToDate(week, gpst_sec);
                
                // 2. 衛星IDと周波数ID
                const sat_id = parts[IDX_SAT_ID];
                const freq_id = parts[IDX_FREQ_ID];
                
                // 3. 疑似距離残差の値
                const residual_val = parseFloat(parts[IDX_RES_CODE]);

                // 4. 対応するデータセットを取得（または作成）
                const dataset = getOrCreateDataset(sat_id, freq_id);
                
                // 5. データを追加
                dataset.data.push({
                    x: time_val,
                    y: residual_val
                });

                // ステータス表示を更新
                statusDisplay.textContent = `最終受信: ${time_val.toLocaleTimeString('ja-JP')} (JST)`;

            } catch (e) {
                console.warn("データ解析エラー:", e, " | 受信データ:", line);
            }
        });

    </script>
</body>
</html>
