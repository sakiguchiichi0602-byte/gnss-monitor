import japanize_matplotlib
import paho.mqtt.client as mqtt
import matplotlib.pyplot as plt
from matplotlib.animation import FuncAnimation
from collections import deque, defaultdict
import datetime as dt
import matplotlib.dates as mdates
from matplotlib.ticker import FormatStrFormatter
import threading
import random

# --- ラズパイ(streamer.py)と設定を合わせる ---
MQTT_BROKER = "test.mosquitto.org"
MQTT_TOPIC = "gnss/raspi/sbf-rtk"
# ----------------------------------------

MAX_POINTS = 200
time_data = deque(maxlen=MAX_POINTS)
lat_data = deque(maxlen=MAX_POINTS)
lon_data = deque(maxlen=MAX_POINTS)
ns_data = deque(maxlen=MAX_POINTS)

# 衛星ごとのSNRデータを保持 (ID: deque)
snr_data = defaultdict(lambda: deque(maxlen=MAX_POINTS))
snr_times = deque(maxlen=MAX_POINTS) # SNR用の共通時刻軸
satellite_colors = {}
satellite_lines = {}

current_solution_status = "---"
current_time = None

STATUS_MAP = {"1": "SINGLE", "2": "DGPS", "4": "FIX", "5": "FLOAT", "0": "INVALID"}

def on_connect(client, userdata, flags, rc):
    if rc == 0:
        print(f"MQTTブローカー ({MQTT_BROKER}) に接続しました。")
        print(f"トピック '{MQTT_TOPIC}' の購読を開始します...")
        client.subscribe(MQTT_TOPIC)
    else:
        print(f"MQTT接続失敗 (code: {rc})")

def parse_nmea_latlon(val_str, direction):
    """NMEAのDDmm.mmmm形式を度(Degree)に変換"""
    val = float(val_str)
    deg = int(val / 100)
    minutes = val - (deg * 100)
    result = deg + (minutes / 60)
    if direction == 'S' or direction == 'W':
        result = -result
    return result

def on_message(client, userdata, msg):
    global current_solution_status, current_time
    try:
        line = msg.payload.decode('utf-8').strip()
        parts = line.split(',')
        
        if line.startswith('$GPGGA'): # 測位結果 (位置, ステータス, 衛星数)
            # $GPGGA,HHMMSS.ss,Lat,N,Lon,E,Q,NS,HDOP,H,M,...
            if len(parts) < 10: return

            # 時刻 (JSTに変換 - NMEAはUTC)
            timestr = parts[1]
            if not timestr: return
            now = dt.datetime.utcnow().replace(
                hour=int(timestr[0:2]), 
                minute=int(timestr[2:4]), 
                second=int(timestr[4:6]),
                microsecond=int(float(timestr[6:])*1000000)
            )
            current_time = now + dt.timedelta(hours=9) # JSTに
            
            lat = parse_nmea_latlon(parts[2], parts[3])
            lon = parse_nmea_latlon(parts[4], parts[5])
            status_q = parts[6]
            ns = int(parts[7])
            
            time_data.append(current_time)
            lat_data.append(lat)
            lon_data.append(lon)
            ns_data.append(ns)
            
            current_solution_status = STATUS_MAP.get(status_q, f"不明({status_q})")
            print(f"受信(GGA): {current_time}, Lat={lat:.6f}, Lon={lon:.6f}, Q={status_q}, NS={ns}")

        elif line.startswith('$GPGSV'): # 衛星ごとのSNR (信号強度)
            # $GPGSV,NumMsg,MsgNum,TotalSats,Sat1,El,Az,SNR,Sat2,El,Az,SNR,...
            if not current_time: return # まだGGAを受信していない
            
            if not snr_times or snr_times[-1] != current_time:
                snr_times.append(current_time)

            # 1行に最大4衛星分の情報
            for i in range(4, len(parts) - 3, 4):
                sat_id = f"G{parts[i]}" # (GPS衛星のみ ($GPGSV) と仮定)
                snr_str = parts[i+3].split('*')[0] # (チェックサムを除去)
                if snr_str:
                    snr = int(snr_str)
                    snr_data[sat_id].append(snr)
                    print(f"受信(GSV): {sat_id}, SNR={snr} dBHz")
                else:
                    # SNRがNULL (追跡中だが値なし)
                    snr_data[sat_id].append(0)

    except Exception as e:
        # print(f"NMEA解析エラー: {e} (データ: {line})")
        pass

def animate(i, fig, ax_track, ax_ns, ax_snr, line_track, line_ns, status_text):
    if not time_data:
        return line_track, line_ns, status_text
    
    # 1. 軌跡グラフ
    line_track.set_data(lon_data, lat_data)
    ax_track.relim()
    ax_track.autoscale_view()
    ax_track.set_aspect('equal', adjustable='datalim')

    # 2. 衛星数グラフ
    line_ns.set_data(time_data, ns_data)
    ax_ns.relim()
    ax_ns.autoscale_view()

    # 3. SNRグラフ
    ax_snr.legend_ = None
    ax_snr.lines.clear() # 衛星が入れ替わるため毎回クリア
    satellite_lines.clear()
    
    for sat_id, data in snr_data.items():
        if not data: continue
        # GSVとGGAの時刻同期 (データ数が合うように調整)
        times_to_plot = list(snr_times)[-len(data):]
        if len(times_to_plot) == len(data):
            if sat_id not in satellite_colors:
                satellite_colors[sat_id] = (random.random(), random.random(), random.random())
            
            line, = ax_snr.plot(times_to_plot, data, '.-', markersize=3, label=sat_id, color=satellite_colors[sat_id])
            satellite_lines[sat_id] = line
    
    ax_snr.relim()
    ax_snr.autoscale_view()
    ax_snr.set_ylim(0, 60) # SNR Y軸を 0-60 dBHzに固定
    ax_snr.legend(loc='upper right', fontsize='small', ncol=2)

    # 4. ステータステキスト
    status_text.set_text(f"測位ステータス: {current_solution_status}")
    if current_solution_status == "FIX": status_text.set_color('green')
    elif current_solution_status == "FLOAT": status_text.set_color('orange')
    else: status_text.set_color('red')

    return line_track, line_ns, status_text

# --- メイン処理 ---
# 1. MQTTクライアントを別スレッドで起動
client = mqtt.Client(mqtt.CallbackAPIVersion.VERSION1)
client.on_connect = on_connect
client.on_message = on_message
threading.Thread(target=client.loop_forever, daemon=True).start()
client.connect(MQTT_BROKER, 1883, 60)

# 2. Matplotlibのグラフ準備
fig = plt.figure(figsize=(14, 8))
fig.suptitle("リアルタイム GNSS監視ダッシュボード (NMEA)", fontsize=16)
gs = fig.add_gridspec(2, 2, height_ratios=[1.5, 1])

# --- 左上の軌跡グラフ ---
ax_track = fig.add_subplot(gs[0, 0])
ax_track.set_title("軌跡 (Lat vs Lon)")
ax_track.set_xlabel("経度 (Longitude)")
ax_track.set_ylabel("緯度 (Latitude)")
ax_track.grid(True)
ax_track.yaxis.set_major_formatter(FormatStrFormatter('%.6f'))
ax_track.xaxis.set_major_formatter(FormatStrFormatter('%.6f'))
line_track, = ax_track.plot([], [], '.-', color='green')

# --- 左下の衛星数グラフ ---
ax_ns = fig.add_subplot(gs[1, 0])
ax_ns.set_title("使用衛星数 (NS from GGA)")
ax_ns.set_xlabel("時刻 (JST)")
ax_ns.set_ylabel("衛星数")
ax_ns.grid(True)
ax_ns.set_ylim(0, 40)
line_ns, = ax_ns.plot([], [], '.-', color='gray')
ax_ns.xaxis.set_major_formatter(mdates.DateFormatter('%H:%M:%S'))

# --- 右側のSNRグラフ (縦に2スパン結合) ---
ax_snr = fig.add_subplot(gs[:, 1])
ax_snr.set_title("衛星ごと信号強度 (SNR from GSV)")
ax_snr.set_xlabel("時刻 (JST)")
ax_snr.set_ylabel("信号強度 (SNR) [dBHz]")
ax_snr.grid(True)
ax_snr.xaxis.set_major_formatter(mdates.DateFormatter('%H:%M:%S'))

# 測位ステータス表示用テキスト (図の最上部)
status_text = fig.text(0.5, 0.95, "測位ステータス: ---", 
                       ha="center", va="bottom", fontsize=14, color="red")

fig.autofmt_xdate(rotation=30) # X軸ラベルを斜めにする

# 3. アニメーションの開始
ani = FuncAnimation(fig, animate, 
                    fargs=(fig, ax_track, ax_ns, ax_snr, line_track, line_ns, status_text),
                    interval=1000,
                    blit=False, # X軸更新のため False
                    cache_frame_data=False)

# 4. グラフウィンドウを表示
plt.tight_layout(rect=[0, 0.03, 1, 0.93])
plt.show()

# 5. グラフを閉じたらMQTTも終了
client.disconnect()
print("モニタリングを終了しました。")